# Simple_machine writeup

四级流水线虚拟机保护。详见idb

```python

vm_code = [
    0x06, 0x24, 0x00, 0x00, 0x00, 0x40, 0x24, 0x00, 0x01, 0x29, 0x00, 0x40, 0x00, 0x40, 0xBD, 0xB0,
    0x04, 0x44, 0x01, 0x00, 0x00, 0x00, 0x00, 0x40, 0x05, 0x20, 0x00, 0x00, 0x01, 0x00, 0xA0, 0x01,
    0x01, 0x29, 0x02, 0x40, 0x02, 0x40, 0xBC, 0xBA, 0x04, 0x44, 0x01, 0x00, 0x00, 0x00, 0x02, 0x40,
    0x05, 0x20, 0x00, 0x00, 0x01, 0x00, 0xA0, 0x01, 0x01, 0x29, 0x04, 0x40, 0x04, 0x40, 0xB9, 0xBE,
    0x04, 0x44, 0x01, 0x00, 0x00, 0x00, 0x04, 0x40, 0x05, 0x20, 0x00, 0x00, 0x01, 0x00, 0xA0, 0x01,
    0x01, 0x29, 0x06, 0x40, 0x06, 0x40, 0xAC, 0xBA, 0x04, 0x44, 0x01, 0x00, 0x00, 0x00, 0x06, 0x40,
    0x05, 0x20, 0x00, 0x00, 0x01, 0x00, 0xA0, 0x01, 0x01, 0x29, 0x08, 0x40, 0x08, 0x40, 0xCE, 0xCF,
    0x04, 0x44, 0x01, 0x00, 0x00, 0x00, 0x08, 0x40, 0x05, 0x20, 0x00, 0x00, 0x01, 0x00, 0xA0, 0x01,
    0x01, 0x29, 0x0A, 0x40, 0x0A, 0x40, 0xCE, 0xCF, 0x04, 0x44, 0x01, 0x00, 0x00, 0x00, 0x0A, 0x40,
    0x05, 0x20, 0x00, 0x00, 0x01, 0x00, 0xA0, 0x01, 0x00, 0x05, 0x00, 0x10, 0x74, 0xF9, 0x00, 0x00,
    0x00, 0x05, 0x02, 0x10, 0x9D, 0x2B, 0x00, 0x00, 0x00, 0x05, 0x04, 0x10, 0xAF, 0x4C, 0x00, 0x00,
    0x00, 0x05, 0x06, 0x10, 0xE1, 0xBE, 0x00, 0x00, 0x00, 0x05, 0x08, 0x10, 0x0D, 0xFC, 0x00, 0x00,
    0x00, 0x05, 0x0A, 0x10, 0x48, 0x6E, 0x00, 0x00, 0x00, 0x05, 0x0C, 0x10, 0x3C, 0xE0, 0x00, 0x00,
    0x00, 0x05, 0x0E, 0x10, 0x22, 0xD3, 0x00, 0x00, 0x00, 0x05, 0x10, 0x10, 0x79, 0x19, 0x00, 0x00,
    0x00, 0x05, 0x12, 0x10, 0xD6, 0x36, 0x00, 0x00, 0x00, 0x05, 0x14, 0x10, 0xE8, 0x40, 0x00, 0x00,
    0x00, 0x05, 0x16, 0x10, 0xF7, 0xCB, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0xAD, 0xDE, 0x00, 0x00,
    0x00, 0x04, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x20, 0x02, 0x00, 0x00, 0x00, 0x02, 0x00,
    0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x02, 0x20, 0x02, 0x00, 0x01, 0x00, 0x02, 0x00,
    0x01, 0x05, 0x54, 0x01, 0x00, 0x10, 0x02, 0x00, 0x01, 0x05, 0x4C, 0x01, 0x0C, 0x40, 0x02, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x08, 0x02, 0x00, 0xFF, 0xFF, 0x00, 0x00,
    0x01, 0x08, 0x02, 0x00, 0xFF, 0xFF, 0x02, 0x00, 0x04, 0x04, 0x02, 0x00, 0x00, 0x00, 0x02, 0x00,
    0x05, 0x20, 0xFF, 0xFF, 0x02, 0x00, 0xA0, 0x01, 0x01, 0x20, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00,
    0x04, 0x20, 0x02, 0x00, 0x01, 0x00, 0x0C, 0x00, 0x05, 0x20, 0xFF, 0xFF, 0x02, 0x00, 0x08, 0x01,
    0x00, 0x05, 0x00, 0x10, 0x47, 0x4F, 0x00, 0x00, 0x00, 0x05, 0x02, 0x10, 0x4F, 0x44, 0x00, 0x00,
    0x00, 0x05, 0x04, 0x10, 0x21, 0x0A, 0x00, 0x00, 0x07, 0x24, 0x00, 0x00, 0x00, 0x10, 0x06, 0x00,
    0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
]

vm_code_len = 424

def get_vmcode_word(addr):
    return vm_code[addr] | (vm_code[addr+1] << 8)

opcode_map = ["mov", "add", "mul", "xor", "cmp", "jnz", "read", "write", "return"]

def get_op(op_type, value):
    if op_type == 2:
        return "vm_code[0x%x]" % value
    elif op_type == 1:
        return "0x%x" % value
    elif op_type == 0:
        # return "[&vm_data_seg+%d]" % value
        return "reg[" + str(value) + "]"
    else:
        assert 0 and "unknow op type"

def get_res(res_type, value):
    if res_type == 2:
        return "vm_code[0x%x]" % value
    elif res_type == 0:
        return "reg[" + str(value) + "]"
    else:
        assert 0 and "unknow res type"

for idx in range(int(vm_code_len/8)):
    # IF
    word1 = get_vmcode_word(8 * idx)
    word2 = get_vmcode_word(8 * idx + 2)
    word3 = get_vmcode_word(8 * idx + 4)
    word4 = get_vmcode_word(8 * idx + 6)

    ID_opcode = word1 & 0x7F
    ID_op2_type = (word1 >> 13) & 7
    ID_op1_type = (word1 >> 10) & 7
    ID_res_type = (word1 >> 7) & 7

    # ID
    op1 = get_op(ID_op1_type, word3)
    op2 = get_op(ID_op2_type, word4)
    res = get_res(ID_res_type, word2)

    vm_asm = "%d \t" % idx
    if op2 == None:
        assert "op2 == None"

    if ID_opcode == 0:
        vm_asm += "%s %s, %s" % (opcode_map[ID_opcode], res, op1)
    elif 1 <= ID_opcode <= 4:
        vm_asm += "%s = %s %s, %s" % (res, opcode_map[ID_opcode], op1, op2)
    elif ID_opcode == 5:
        vm_asm += "%s (%s) %s/8" % (opcode_map[ID_opcode], op1, op2)
    elif ID_opcode == 6:
        vm_asm += "%s(&[%s], %s)" % (opcode_map[ID_opcode], op1, op2)
    elif ID_opcode == 7:
        vm_asm += "%s(&[%s], %s)" % (opcode_map[ID_opcode], op1, op2)
    elif ID_opcode == 8:
        vm_asm += "return"


    print vm_asm


"""
0 	read(&[0x4000], 0x24)
1 	vm_code[0x4000] = add vm_code[0x4000], 0xb0bd
2 	reg[1] = cmp 0x0, vm_code[0x4000]
3 	jnz (reg[1]) 0x1a0/8
4 	vm_code[0x4002] = add vm_code[0x4002], 0xbabc
5 	reg[1] = cmp 0x0, vm_code[0x4002]
6 	jnz (reg[1]) 0x1a0/8
7 	vm_code[0x4004] = add vm_code[0x4004], 0xbeb9
8 	reg[1] = cmp 0x0, vm_code[0x4004]
9 	jnz (reg[1]) 0x1a0/8
10 	vm_code[0x4006] = add vm_code[0x4006], 0xbaac
11 	reg[1] = cmp 0x0, vm_code[0x4006]
12 	jnz (reg[1]) 0x1a0/8
13 	vm_code[0x4008] = add vm_code[0x4008], 0xcfce
14 	reg[1] = cmp 0x0, vm_code[0x4008]
15 	jnz (reg[1]) 0x1a0/8
16 	vm_code[0x400a] = add vm_code[0x400a], 0xcfce
17 	reg[1] = cmp 0x0, vm_code[0x400a]
18 	jnz (reg[1]) 0x1a0/8

19 	mov vm_code[0x1000], 0xf974
20 	mov vm_code[0x1002], 0x2b9d
21 	mov vm_code[0x1004], 0x4caf
22 	mov vm_code[0x1006], 0xbee1
23 	mov vm_code[0x1008], 0xfc0d
24 	mov vm_code[0x100a], 0x6e48
25 	mov vm_code[0x100c], 0xe03c
26 	mov vm_code[0x100e], 0xd322
27 	mov vm_code[0x1010], 0x1979
28 	mov vm_code[0x1012], 0x36d6
29 	mov vm_code[0x1014], 0x40e8
30 	mov vm_code[0x1016], 0xcbf7
31 	mov reg[0], 0xdead
32 	mov reg[1], 0x0

33 	reg[2] = mul reg[0], 0x2
34 	reg[0] = xor reg[0], reg[2]
35 	reg[2] = mul reg[1], 0x2
36 	vm_code[0x154] = add 0x1000, reg[2]
37 	vm_code[0x14c] = add 0x400c, reg[2]
38 	mov reg[0], reg[0]
39 	mov reg[0], reg[0]
40 	mov reg[0], reg[0]
41 	reg[2] = xor vm_code[0xffff], reg[0]
42 	reg[2] = add vm_code[0xffff], reg[2]

43 	reg[2] = cmp 0x0, reg[2]
44 	jnz (reg[2]) 0x1a0/8
45 	reg[1] = add reg[1], 0x1
46 	reg[2] = cmp reg[1], 0xc
47 	jnz (reg[2]) 33

48 	mov vm_code[0x1000], 0x4f47
49 	mov vm_code[0x1002], 0x444f
50 	mov vm_code[0x1004], 0xa21
51 	write(&[0x1000], 0x6)
52 	return
"""



d = [
    0xf974,
    0x2b9d,
    0x4caf,
    0xbee1,
    0xfc0d,
    0x6e48,
    0xe03c,
    0xd322,
    0x1979,
    0x36d6,
    0x40e8,
    0xcbf7,
]

res = ""

reg0 = 0xdead

for reg1 in range(0xc):
    reg2 = (reg0 * 2) & 0xFFFF
    reg0 = (reg0 ^ reg2) & 0xFFFF
    reg2 = (reg1 * 2) & 0xFFFF
    # print hex((d[reg1] ^ reg0))
    r = (0x10000-d[reg1]) ^ reg0
    res += chr(r&0xff)
    res += chr((r>>8)&0xFF)

print "CODEGATE2020" + res

# CODEGATE2020{ezpz_but_1t_1s_pr3t3xt}

```

